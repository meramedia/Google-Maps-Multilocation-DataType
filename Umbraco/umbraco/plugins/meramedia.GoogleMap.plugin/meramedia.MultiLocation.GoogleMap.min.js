function MapStateListener(){var n=this;this.MapInitializedEvent=function(n){var t,i,r;this._ClearMap(n),n.markerList=$(n.container).find("[id^=markerList]"),meramedia.Context.SetDefaultLocation(n.container,n.map,n.settings.MapOptions.center),t=$(n.container).find("input.place")[0],i=new google.maps.places.Autocomplete(t),i.bindTo("bounds",n.map),r=n.map,$(n.container).find("input.search").click(function(t){t.preventDefault();var i=$(n.container).find("input.place").val(),r=new google.maps.Geocoder;r.geocode({address:i},function(t,i){n._ClearSearchMarkers(),i==google.maps.GeocoderStatus.OK&&($.each(t,function(){var t=this,i=t.formatted_address,r=t.geometry.location;n.CreateSearchMarker(r,i)}),n._ZoomToFit())})})},this.StateChangeEvent=function(){},this.MarkerDragedEvent=function(n,t){this.MarkerUpdatedEvent(n,t)},this.MarkerAddedEvent=function(n,t){this._AddMarkerTolist(n,t)},this.MarkerRemovedEvent=function(n,t){t.container.remove()},this.MarkerUpdatedEvent=function(n,t){this._UpdateMarkerLocationValue(n,t)},this.RerenderBeginEvent=function(n){this._UpdateSaveValue(n)},this.RerenderFinishedEvent=function(){},this.MarkerLeftClickEvent=function(){},this.MarkerCreatedEvent=function(n,t){this._AddMarkerTolist(n,t),this._UpdateMarkerLocationValue(n,t)},this._UpdateMarkerLocationValue=function(n,t){var i=new google.maps.Geocoder;i.geocode({location:t.getPosition()},function(n,i){if(i==google.maps.GeocoderStatus.OK)if(n.length>0){var r=n[0],u=r.formatted_address;t.name!=undefined&&t.name!=null&&(u=t.name+"\n"+u),t._title=r.formatted_address,t.setTitle(u),t.container.find("span.position").html(r.formatted_address)}else t.container.find("span.position").html(t.getPosition())})},this._AddMarkerTolist=function(t,i){var c=t.map,r=i.id,f=[],o=$(t.container).find(".markerValueList").val(),s,h,e,u;for(o!=""&&o!=undefined&&(f=$.parseJSON(o)),s='<li id="google-marker-'+r+'"><div class="name"><div class="label"><label for="marker_'+r+'_name">Marker name<\/label><p>Specific name for the location, ex. "H&auml;lsans hus"<\/p><\/div><div><input type="text" name="marker_'+r+'_name" value="'+(i.name!=undefined&&i.name!=null?i.name:"")+'"><\/div><\/div>'+(t.settings.BackOfficeSettings.AllowCustomLinks?'<div class="link"><div class="label"><label for="marker_'+r+'_link">External link<\/label><\/div><div><input type="text" name="marker_'+r+'_link" value="'+(i.link!=null?i.link:"")+'"><\/div><\/div>':"")+'<div><div class="label"><label for="marker_'+r+'_position">Position<\/label><\/div><div><a class="changePosition" title="Click to go to marker" id="'+r+'" data-position="'+i.getPosition().lat()+","+i.getPosition().lng()+'" href="#" title="Remove marker from map"><span class="position">'+i.getPosition()+'<\/span><\/a><\/div><\/div><div><div class="label"><label for="marker_'+r+'_icon">Marker icon<\/label><\/div><div><select class="dropdownSource" name="marker_'+r+'_icon"><option selected="selected" value="default">Default<\/option>',h=null,e=0;e<f.length;e++)s+="<option value="+f[e].id+">"+f[e].url+"<\/option>",f[e].url==i.getIcon()&&(h=f[e].id);s+='<\/select><span class="iconPreview"><\/span><dl class="dropdownTarget dropdown"><\/dl><\/div><\/div><a class="removeMarker" href="#"><\/a><\/li>',u=$(s),u.find("#marker_"+r).val(i.name),i.getIcon()!=null&&u.find("span.iconPreview").html('<img src="'+i.getIcon()+'"/>'),u.find("a.changePosition").click(function(n){n.preventDefault(),c.setCenter(i.getPosition()),i.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){i.setAnimation(null)},1e3)}),u.find("a.removeMarker").click(function(n){n.preventDefault(),t.RemoveMarker(i)}),u.find("input[name=marker_"+r+"_name]").keyup(function(){i.name=$(this).val()}),u.find("input[name=marker_"+r+"_link]").keyup(function(){i.link=$(this).val()}),t.HasRegisteredUpdate!=undefined&&t.HasRegisteredUpdate||($("input[class*=editorIcon]").click(function(){n._UpdateSaveValue(t)}),t.HasRegisteredUpdate=!0),h!=null&&(u.find(".dropdownSource").children("option:selected").attr("selected",!1),u.find(".dropdownSource").children("option[value="+h+"]").attr("selected",!0)),u.find(".dropdownSource").change(function(){var n=$(this).val(),t=$(this).find("option[value="+n+"]").html();n=="default"?i.setIcon(null):i.setIcon(t),i.getIcon()==null?$(this).parent().children("span.iconPreview").html(""):$(this).parent().children("span.iconPreview").html('<img src="'+t+'"/>')}),t.markers[r]=i,t.markerList.append(u),i.container=u},this.ForceSaveSettingsEvent=function(n){this._UpdateSaveValue(n)},this._UpdateSaveValue=function(n){var f=[],u=n.map,t=new MapSettings,e,i,r,o;t.MapOptions.zoom=u.getZoom(),t.MapOptions.center=u.getCenter().lat()+","+u.getCenter().lng(),t.MapOptions.mapTypeId=u.getMapTypeId(),t._Width=$(n.container).find("input.mapWidth").val(),t._Height=$(n.container).find("input.mapHeight").val(),t.CoreSettings.AllowCustomLinks=n.settings.BackOfficeSettings.AllowCustomLinks;for(e in n.markers)i=n.markers[e],r=new LocationMarker,r.Position=i.getPosition().lat()+","+i.getPosition().lng(),r.Title=i._title,r.Icon=i.getIcon()==undefined||i.getIcon==null?null:i.getIcon(),r.Name=i.name,r.Link=i.link,f.push(r);t.Markers=f,o=$.getJSON(t),$(n.container).find("input[id*=hiddenLocations_]").attr("value",o)},this._ClearMap=function(n){n.markerList!=undefined&&n.markerList.html("")}}function StartApplication(){google.maps.Marker.CurrentMarkerId=0,$("div.gmapContainer").each(function(){var t=$("div.map",this).attr("id"),i=$(this).find("input.mapSettings").val(),n=$(this).find("input.hiddenLocations").val();n=n!=null&&n!=""?$.parseJSON(n):new MapSettings,n.BackOfficeSettings=$.parseJSON(i),meramedia.Context.maps[t]=new GoogleMap(t,n,[new MapStateListener(this)],n==null?null:n.Markers),meramedia.Context.maps[t].container=this});var t=$(".tabOn"),n=$("#"+t.attr("id")+"layer").find(".map");n.ready(function(){for(var i,t=0;t<n.length;t++)i=$(n[t]).attr("id"),meramedia.Context.maps[i].Initialize()}),$("a").click(function(){var n=$(this).attr("id");n&&n.indexOf("TabView")>-1&&(n=n.replace(/^(.*\_tab\d+).*$/,"$1")+"layer",$("#"+n).each(function(){$("div.map",this).each(function(){var r=jQuery(this).attr("id"),t=meramedia.Context.maps[r],n,i;t.IsInitialized()?(t.ForceSave(),n=$(t.container).find("input.hiddenLocations").attr("value"),n=n!=undefined&&n!=null&&n!=""?$.parseJSON(n):new MapSettings,i=$(t.container).find("input.hiddenLocations").val(),i!=null&&i!=""&&(i=$.parseJSON(i)),t.Rerender({zoom:n.MapOptions.zoom,center:new google.maps.LatLng(n.MapOptions.center.split(",")[0],n.MapOptions.center.split(",")[1]),mapTypeId:n.MapOptions.mapTypeId},i.Markers!=undefined?i.Markers:null)):t.Initialize()})}))})}$(function(){LoadMapsApi("StartApplication")})