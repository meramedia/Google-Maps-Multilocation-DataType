function MapSettings(){this.Markers=null,this.MapOptions={zoom:12,center:"0,0",mapTypeId:google.maps.MapTypeId.ROADMAP},this._Width=null,this._Height=null,this.MapTypeId=google.maps.MapTypeId.ROADMAP,this.CoreSettings={AllowCustomLinks:!1},this.BackOfficeSettings={AllowCustomLinks:!1,MaxMarkers:-1,MinMarkers:0,DefaultWidth:500,DefaultHeight:500},this.UserCustomizable=!0}function LocationMarker(){this.Name=null,this.Title=null,this.Position=null,this.Content=null,this.Icon=null,this.Link=null}function LoadMapsApi(n){LoadedApi()?(meramedia.warn("Already loaded Google Maps api"),n()):$.ajax({type:"get",dataType:"script",url:"http://maps.google.com/maps/api/js",data:{v:"3.9",libraries:"places",sensor:!1,callback:n},error:function(){alert("Could not load Google Maps API")}})}function GoogleMap(n,t,i,r){var u=this;this.settings=t,(t==undefined||t==null)&&(this.settings=new MapSettings),this.settings.MapOptions.center=new google.maps.LatLng(this.settings.MapOptions.center.split(",")[0],this.settings.MapOptions.center.split(",")[1]),this._markerAddOnInitialize=r,this.id=n,this.searchMarkers=[],this.listeners=i==undefined?[]:i,this.markers={},this.numMarkers=0,this._updatedBounds=!1,this._initialized=!1,this.IsInitialized=function(){return this._initialized},this.ForceSave=function(){for(var n=0;n<u.listeners.length;n++)u.listeners[n].ForceSaveSettingsEvent(this)},this._ZoomToFit=function(){var n=new google.maps.LatLngBounds,i,t;for(i in this.markers)n.extend(this.markers[i].getPosition());for(t=0;t<this.searchMarkers.length;t++)n.extend(this.searchMarkers[t].getPosition());this._updatedBounds=!0,this.map.fitBounds(n)},this.ZoomToFit=this._ZoomToFit,this.RemoveMarker=function(n,t){if(meramedia.log("[GoogleMaps] Removing marker "+n.id+" from map"),typeof t=="undefined"||t==null||!t){delete this.markers[n.id];for(var i=0;i<u.listeners.length;i++)u.listeners[i].MarkerRemovedEvent(u,n);u.numMarkers--}n.setMap(null)},this.RemoveAllMarkers=function(){for(var n in u.markers)n!=null&&n!=undefined&&u.RemoveMarker(u.markers[n],!1)},this.CreateSearchMarker=function(n,t){var i=this.CreateMarker(n,null,t,{clickable:!0,draggable:!1,position:n,title:t==null?"":t,visible:!0,zIndex:100,icon:meramedia.Context.DefaultSearchIcon},!1);i.setMap(this.map),this.searchMarkers.push(i),google.maps.event.addListener(i,"rightclick",function(){u.CreateMarker(i.getPosition(),null,i.getTitle()),u.RemoveMarker(i,!0)})},this._ClearSearchMarkers=function(){for(var n=0;n<this.searchMarkers.length;n++)this.searchMarkers!=null&&this.searchMarkers[n].setMap(null);this.searchMarkers=[]},this.CreateMarker=function(n,t,i,r,f){var o,e,s;if(meramedia.log("[GoogleMaps] Creating marker "+t),o=null,(typeof f=="undefined"||f==null)&&(f=!0),o=typeof r=="undefined"||r==null?{clickable:!0,draggable:!0,position:n,title:i==null?"":i,visible:!0,zIndex:10}:r,(t!=undefined&&t!=null?t+"\n":"")&&(o.title=t+"\n"+(i==undefined||i==null?r!=null?r.title:"":i)),e=new google.maps.Marker(o),e.id=this._GetMarkerId(),e.name=t,e._title=i,f){if(meramedia.log("[GoogleMaps] Adding marker to the map"),u.settings.MaxMarkers!=-1&&u.numMarkers>=u.settings.MaxMarkers)return alert("You may only add "+u.numMarkers+" markers to the map"),null;for(e.setMap(this.map),s=0;s<u.listeners.length;s++)u.listeners[s].MarkerCreatedEvent(u,e);this.RegisterMarkerEvents(e),u.numMarkers++,u.markers[e.id]=e}else meramedia.warn("[GoogleMap] Skipping the process of adding the marker to the map");return e},this.Rerender=function(n,t){meramedia.log("[GoogleMap] Re-rendering the map..."),this.Initialize(!0,n,t)},this._RegisterMarkerEvents=function(n){google.maps.event.addListener(n,"rightclick",function(){u.RemoveMarker(n)}),google.maps.event.addListener(n,"dragend",function(){for(var i=0;i<u.listeners.length;i++)u.listeners[i].MarkerUpdatedEvent(u,n)})},this.RegisterMarkerEvents=this._RegisterMarkerEvents,this.RegisterBaseEvents=function(){google.maps.event.addListenerOnce(u.map,"bounds_changed",function(){u.numMarkers==1&&u._updatedBounds&&(u._updatedBounds=!1,u.map.setZoom(10))})},this._RegisterEvents=function(){google.maps.event.addListener(u.map,"rightclick",function(n){u.CreateMarker(n.latLng,null,null)}),google.maps.event.addListener(u.map,"center_changed",function(){for(var t=0;t<u.listeners.length;t++)u.listeners[t].StateChangeEvent(u,"center_changed")}),google.maps.event.addListener(u.map,"zoom_changed",function(){for(var t=0;t<u.listeners.length;t++)u.listeners[t].StateChangeEvent(u,"zoom_changed")}),google.maps.event.addListener(u.map,"maptypeid_changed",function(){for(var t=0;t<u.listeners.length;t++)u.listeners[t].StateChangeEvent(u,"maptypeid_changed")})},this.RegisterEvents=this._RegisterEvents,this.SetUserCustomizable=function(n){meramedia.warn("[GoogleMaps] Settings UserCustomizable to "+n),n?(this.RegisterEvents=this._RegisterEvents,this.RegisterMarkerEvents=this._RegisterMarkerEvents):(meramedia.warn("[GoogleMaps] Unbinding RegisterEvents and RegisterMarkerEvents"),this.RegisterEvents=function(){},this.RegisterMarkerEvents=function(){})},this.Initialize=function(n,t,i){var r;if(meramedia.log("[GoogleMaps] Initializing map"),(n==null||n==undefined)&&(n=!1),n){for(meramedia.log("[GoogleMap] Notifying listeners about RerenderBeginEvent"),r=0;r<u.listeners.length;r++)u.listeners[r].RerenderBeginEvent(u);u.RemoveAllMarkers()}if(meramedia.log("[GoogleMaps] Rerender: "+n),this.IsInitialized()&&!n){meramedia.log("[GoogleMaps] Skipping initialization, already intialized!");return}for(n&&(meramedia.log("[GoogleMaps] Re-rendering map"),u.settings.MapOptions=t),this.SetUserCustomizable(this.settings.UserCustomizable),this.map=new google.maps.Map(document.getElementById(this.id),this.settings.MapOptions),this.RegisterEvents(),this.RegisterBaseEvents(),u._initialized=!0,meramedia.log("[GoogleMaps] Notifying listeners about initalization DONE! (Rerender: "+n+")"),r=0;r<u.listeners.length;r++)u.listeners[r].MapInitializedEvent(u);n&&i!=null&&i!=undefined&&(this._markerAddOnInitialize=i),this._markerAddOnInitialize!=null&&this._markerAddOnInitialize!=undefined&&(meramedia.log("[GoogleMaps] Adding markers to map from mapSettings"),$.each(this._markerAddOnInitialize,function(){meramedia.log("[GoogleMaps] Creating marker at position "+this.Position);var n=u.CreateMarker(null,this.Name==undefined?null:this.Name,null,{clickable:!0,draggable:u.settings.UserCustomizable,position:new google.maps.LatLng(this.Position.split(",")[0],this.Position.split(",")[1]),title:this.Title==null?"":this.Title,visible:!0,icon:this.Icon==undefined?null:this.Icon,zIndex:10,link:this.Link==undefined?null:this.Link});meramedia.log("[GoogleMaps] ("+n.id+") Created marker"),n.party="Hello world",google.maps.event.addListener(n,"click",function(){for(var t=0;t<u.listeners.length;t++)u.listeners[t].MarkerLeftClickEvent(u,n)})}))},this._GetMarkerId=function(){return meramedia.Context.CurrentMarkerId++}}var LoadedApi=function(){return typeof google!="undefined"&&typeof google.maps!="undefined"},meramedia=typeof meramedia=="undefined"||meramedia==null?{}:meramedia;meramedia.debug=!1,meramedia.log=console==undefined||meramedia.debug!=undefined&&!meramedia.debug?function(){}:function(n){console.log(n)},meramedia.warn=console==undefined||meramedia.debug!=undefined&&!meramedia.debug?function(){}:function(n){console.warn(n)},meramedia.Context=typeof meramedia.Context=="undefined"||meramedia.Context==null?{maps:[]}:meramedia.Context,meramedia.Context.DefaultSearchIcon="/umbraco/plugins/meramedia.GoogleMap.plugin/searchIcon.png",meramedia.Context.CurrentMarkerId=0,meramedia.Context.SetDefaultLocation=meramedia.Context.SetDefaultLocation==undefined?meramedia.Context.SetDefaultLocation=function(n,t,i){var r=$("#"+n.id).find("input.mapSettings").val(),u;r!=null&&r!=undefined&&(r=JSON.parse(r).defaultLocation),typeof i!="undefined"&&i!=null&&i.lat()!=0&&i.lng()!=0?coords=i:r==undefined?coords=new google.maps.LatLng(37.4419,-122.1419):r.match(/^\-*[\d\.]+,\-*[\d\.]+,\d+/)?(u=r.split(","),coords=new google.maps.LatLng(parseFloat(u[0]),parseFloat(u[1])),zoom=parseInt(u[2])):r.match(/^\-*[\d\.]+,\-*[\d\.]+$/)?(u=r.split(","),coords=new google.maps.LatLng(parseFloat(u[0]),parseFloat(u[1]))):coords=new google.maps.LatLng(37.4419,-122.1419),t.setCenter(coords)}:meramedia.Context.SetDefaultLocation